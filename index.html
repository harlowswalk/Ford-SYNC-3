<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bike Infotainment System - Sync 3 Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        .theme-dark {
            --theme-bg: #0c1c2c;
            --theme-bg-secondary: #081624;
            --theme-surface: #1a2938;
            --theme-surface-med: #2c3a4a;
            --theme-text-primary: #d0d2d3;
            --theme-text-secondary: #a0a2a3;
            --theme-accent: #0090ce;
            --theme-border: #2c3a4a;
        }
        .theme-light {
            --theme-bg: #e9eef2;
            --theme-bg-secondary: #ffffff;
            --theme-surface: #ffffff;
            --theme-surface-med: #f0f2f5;
            --theme-text-primary: #0c1c2c;
            --theme-text-secondary: #5c6a7a;
            --theme-accent: #0078b4;
            --theme-border: #d0d2d3;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #000;
            overflow: hidden;
        }
        .infotainment-container {
            width: 100vw;
            height: 100vh;
            background: var(--theme-bg);
            color: var(--theme-text-primary);
            display: flex;
            flex-direction: column;
            max-width: 800px;
            max-height: 480px;
            margin: auto;
            border-radius: 0.5rem;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .content-area {
            flex-grow: 1;
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transform: scale(1.02);
            transition: opacity 0.25s ease-in-out, transform 0.25s ease-in-out;
            background-color: var(--theme-bg);
            overflow-y: auto;
        }
        .screen.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        
        .dock {
            display: flex;
            justify-content: space-around;
            background-color: var(--theme-bg-secondary);
            border-top: 1px solid var(--theme-border);
            flex-shrink: 0;
        }
        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-grow: 1;
            border-left: 1px solid var(--theme-border);
            color: var(--theme-text-secondary);
        }
        .dock-item svg { fill: var(--theme-text-secondary); }
        .dock-item:first-child { border-left: none; }
        .dock-item.active {
            background-color: var(--theme-accent);
            color: white;
        }
        .dock-item.active svg { fill: white; }
        .dock-item svg {
            width: 28px;
            height: 28px;
            margin-bottom: 0.25rem;
        }
        .dock-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        #startup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        #startup-screen.hidden { opacity: 0; pointer-events: none; }
        #startup-screen svg { width: 150px; height: auto; }

        /* Login Screen */
        #login-screen { z-index: 9990; }
        .login-box { background-color: var(--theme-bg-secondary); padding: 2rem; border-radius: 0.5rem; width: 100%; max-width: 380px; }
        .login-box h2 { font-size: 1.8rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; }
        .login-box input { width: 100%; background-color: var(--theme-surface); border: 1px solid var(--theme-border); border-radius: 0.25rem; padding: 0.75rem; color: var(--theme-text-primary); margin-bottom: 1rem; }
        .login-box button { width: 100%; padding: 0.75rem; border-radius: 0.25rem; font-weight: bold; }
        .login-box .btn-primary { background-color: var(--theme-accent); color: white; }
        .login-box .btn-secondary { background-color: transparent; border: 1px solid var(--theme-border); color: var(--theme-text-secondary); margin-top: 0.5rem; }


        /* Home Screen */
        #home-screen {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 0;
            padding: 0;
        }
        #home-map-container {
            height: 100%;
            width: 100%;
        }
        #home-widget-area {
            display: flex;
            flex-direction: column;
            background-color: var(--theme-bg-secondary);
            border-left: 1px solid var(--theme-border);
        }
        .home-widget {
            flex-grow: 1;
            padding: 1rem;
            border-bottom: 1px solid var(--theme-border);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .home-widget:last-child { border-bottom: none; }
        .home-widget h3 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--theme-accent);
            margin-bottom: 0.5rem;
        }
        .home-widget p { color: var(--theme-text-primary); }
        
        /* Nav Screen & POI Screen */
        #nav-screen, #poi-screen { padding: 0; position: relative; }
        #map, #poi-map { height: 100%; width: 100%; }
        .nav-search-bar { position: absolute; top: 1rem; right: 1rem; z-index: 1000; width: 40%; }
        .nav-search-bar input { width: 100%; padding: 0.75rem 1rem; border-radius: 4px; border: 1px solid var(--theme-border); background-color: rgba(255, 255, 255, 0.8); color: var(--theme-text-primary); }
        .theme-dark .nav-search-bar input { background-color: rgba(12, 28, 44, 0.8); }
        #turn-by-turn-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            background-color: var(--theme-surface);
            color: var(--theme-text-primary);
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
            flex-direction: column;
            width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        #turn-by-turn-container.visible { display: flex; }
        #tbt-next-turn { display: flex; align-items: center; gap: 1rem; }
        #tbt-icon { flex-shrink: 0; }
        #tbt-icon svg { width: 48px; height: 48px; }
        #tbt-distance { font-size: 1.5rem; font-weight: bold; }
        #tbt-road { font-size: 1.1rem; }
        #poi-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }
        #poi-controls button {
            background-color: var(--theme-surface);
            color: var(--theme-text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--theme-border);
            font-weight: 500;
        }

        
        /* Apps Screen */
        #apps-screen { display: flex; align-items: center; justify-content: center; }
        .apps-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; }
        .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-item .icon-bg { width: 80px; height: 80px; border-radius: 0.5rem; background-color: var(--theme-surface); display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .theme-dark .app-item .icon-bg { box-shadow: none; }
        .app-item:hover .icon-bg { background-color: var(--theme-surface-med); }
        .app-item span { font-size: 0.8rem; font-weight: 500; }
        
        /* Universal App Header */
        .app-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--theme-border);
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--theme-text-primary);
        }
        
        /* Settings Screen */
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--theme-border); }
        .theme-options { display: flex; gap: 0.5rem; }
        .theme-options button { padding: 0.5rem 1rem; border: 2px solid var(--theme-border); background: transparent; color: var(--theme-text-secondary); border-radius: 99px; font-weight: 500; }
        .theme-options button.active { border-color: var(--theme-accent); background-color: var(--theme-accent); color: white; }

        /* Maintenance Screen */
        #maintenance-list { display: flex; flex-direction: column; gap: 1rem; }
        .maintenance-item { background-color: var(--theme-surface); border-radius: 0.5rem; padding: 1rem; }
        .maintenance-item .progress-bar-bg { background-color: var(--theme-surface-med); border-radius: 99px; height: 8px; overflow: hidden; }
        .maintenance-item .progress-bar { height: 100%; border-radius: 99px; transition: width 0.5s, background-color 0.5s; }
        
        /* Comms Screen */
        .contact-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .contact-item { background-color: var(--theme-surface); border-radius: 0.5rem; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .contact-item .name { font-size: 1.2rem; font-weight: 500; }
        .contact-item .actions { display: flex; gap: 1rem; }
        .contact-item .actions a { background-color: var(--theme-surface-med); padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Gemini/Search Screen */
        #search-screen { display: flex; flex-direction: column; height: 100%; }
        .chat-container { flex-grow: 1; overflow-y: auto; padding-bottom: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .chat-message { max-width: 80%; padding: 0.75rem 1.25rem; border-radius: 1.25rem; line-height: 1.5; }
        .chat-message.user { background-color: var(--theme-accent); color: white; align-self: flex-end; }
        .chat-message.gemini { background-color: var(--theme-surface-med); align-self: flex-start; }
        .chat-input-form { display: flex; padding-top: 1rem; border-top: 1px solid var(--theme-border); }

        /* YouTube/Spotify Screen */
        #youtube-screen, #spotify-screen { display: flex; flex-direction: column; height: 100%; }
        #youtube-player-container, #spotify-player-container { flex-grow: 1; background-color: #000; border-radius: 0.5rem; overflow: hidden; }
        #youtube-player-container iframe, #spotify-player-container iframe { width: 100%; height: 100%; border: 0; }
        
        /* Notification */
        .notification {
            position: absolute;
            top: 1rem;
            left: -100%;
            background-color: var(--theme-accent);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0 0.5rem 0.5rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            transition: left 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            font-weight: 500;
        }
        .notification.show {
            left: 0;
        }

        /* Confirmation Modal */
        #confirm-modal {
            display: none;
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }
        
        /* Sleep Screen */
         #sleep-screen {
            display: none;
            cursor: pointer;
            position: absolute;
            inset: 0;
            background-color: #000;
            z-index: 9997;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            flex-direction: column;
        }
        #sleep-screen.active {
            display: flex;
            opacity: 1;
        }
        #sleep-screen .sleep-content {
             opacity: 0;
             animation: fadeInFromRed 1s 0.3s forwards;
        }
        @keyframes fadeInFromRed {
            0% { opacity: 0; color: #ff5555; }
            100% { opacity: 1; color: white; }
        }
        .main-content-wrapper.fade-out {
            opacity: 0;
            transition: opacity 0.4s;
        }
        .leaflet-popup-content-wrapper {
            background: var(--theme-surface);
            color: var(--theme-text-primary);
            border-radius: 8px;
        }
        .leaflet-popup-tip {
            background: var(--theme-surface);
        }
        .leaflet-popup-close-button {
            color: var(--theme-text-primary) !important;
        }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="infotainment-container" class="infotainment-container">
        <div id="startup-screen">
            <svg viewBox="0 0 400 156.9"><path fill="#FFFFFF" d="M124.9,156.9c-11,0-21-3.3-29.8-9.8c-8.9-6.5-14.8-15.8-17.9-27.9c-3.1-12.1-2.9-24.9,0.5-38.3 C81.1,67.6,88.1,56,98.6,46.8c10.5-9.2,22.8-15.8,36.8-19.8c14-4,28.6-4.9,43.7-2.7c15.1,2.2,29.5,7.5,43,15.9 c13.5,8.4,25.2,19.3,34.9,32.7c9.7,13.4,16.5,28.6,20.4,45.5c2.3,10.2,3.5,20.2,3.5,30.1c0,0.2,0,0.3,0,0.5h-47.6 c-0.2-7.1-1.3-13.9-3.4-20.4c-3.6-11.3-10.1-20.8-19.5-28.5c-9.4-7.7-21-12.5-34.5-14.4c-13.5-1.9-27.8-0.7-42.8,4.9 c-15,5.6-29,14.3-42,26.2c-2.9,2.6-5.6,5.3-8.1,8.1c-0.1,0.1-0.2,0.2-0.2,0.3c0,0-0.1,0-0.1,0.1c-2.4,2.8-4.7,5.6-6.8,8.5 c-2.1,2.9-4,5.9-5.6,8.9c-1.6,3-3,6-4.1,9.1c-1,3.1-1.8,6.2-2.3,9.2H0c1.6-13.4,6-26.3,13.3-38.8 C20.5,103,29.5,92.2,40,83.1c10.5-9,22.2-16.1,35.1-21.2C88,56.8,101.4,54,115.1,54c12.1,0,24.3,2.2,36.5,6.6 c12.2,4.4,23.8,11,34.7,19.8c10.9,8.8,20.4,19.6,28.5,32.3c8.1,12.7,14.2,26.9,18.3,42.4h42.6c-4.4-18.9-11.4-36.4-21-52.5 c-9.7-16.1-22.1-29.8-37.3-41c-15.2-11.2-32.6-19.2-52.1-24c-19.5-4.8-40-5.6-61.6-2.4c-21.6,3.2-42,10.4-61.2,21.6 C24.2,32.3,10.3,45.8,0,62V0h284.4v42.2H47.4v114.7H124.9z"/></svg>
            <h2 class="text-2xl font-light mt-4 tracking-wider text-white/80">SYNC</h2>
        </div>
        
        <div id="login-screen" class="screen flex items-center justify-center">
            <div class="login-box">
                <h2>Sign In</h2>
                <form id="signin-form">
                    <input type="email" id="email-input" placeholder="Email" required>
                    <input type="password" id="password-input" placeholder="Password" required>
                    <button type="submit" class="btn-primary">Sign In</button>
                </form>
                <button id="guest-button" class="btn-secondary">Continue as Guest</button>
            </div>
        </div>
        
        <div class="main-content-wrapper" style="display: none; flex-grow: 1; flex-direction: column; display: flex;">
            <div class="content-area">
                <div id="home-screen" class="screen">
                    <div id="home-map-container"></div>
                    <div id="home-widget-area">
                        <div class="home-widget">
                            <h3>Media</h3>
                            <p id="home-music-track" class="text-lg font-bold">Not Connected</p>
                            <p id="home-music-artist" class="text-gray-400">Connect to phone</p>
                        </div>
                        <div class="home-widget flex flex-col items-center justify-center text-center">
                            <h3>Speed</h3>
                            <p id="home-speed-display" class="text-6xl font-bold leading-none">0</p>
                            <p id="home-speed-unit" class="text-lg text-gray-400">km/h</p>
                        </div>
                         <div class="home-widget">
                            <h3>Status</h3>
                            <div id="home-gps-status" class="text-lg">Acquiring GPS...</div>
                            <div id="home-temp-status" class="text-lg">--Â°C</div>
                        </div>
                    </div>
                </div>
                <div id="nav-screen" class="screen">
                    <div id="turn-by-turn-container">
                        <div id="tbt-next-turn">
                            <div id="tbt-icon"></div>
                            <div>
                                <p id="tbt-distance"></p>
                                <p id="tbt-road"></p>
                            </div>
                        </div>
                    </div>
                     <div class="nav-search-bar">
                        <form id="nav-search-form"><input type="text" id="nav-search-input" placeholder="Where to?"></form>
                    </div>
                    <div id="map"></div>
                </div>
                 <div id="apps-screen" class="screen">
                    <div id="apps-grid" class="apps-grid">
                        <!-- App items are rendered here by JS -->
                    </div>
                </div>
                <div id="poi-screen" class="screen">
                    <div id="poi-controls">
                        <button data-poi="cafe">Cafes</button>
                        <button data-poi="bicycle_shop">Bike Shops</button>
                        <button data-poi="drinking_water">Water</button>
                    </div>
                    <div id="poi-map"></div>
                </div>
                <div id="music-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Media</h2>
                     <div class="flex-grow flex items-center justify-center gap-8">
                         <img id="album-art-large" src="https://placehold.co/200x200/1a2938/2c3a4a?text=Media" class="rounded-lg shadow-lg">
                         <div class="w-64">
                            <h2 id="music-track-title" class="text-2xl font-bold">Not Connected</h2>
                            <p id="music-track-artist" class="text-lg text-gray-400">Connect to phone</p>
                            <div class="flex items-center justify-center space-x-6 mt-4">
                                <button id="prev-btn" class="text-gray-300 hover:text-white"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.208V5.792a1 1 0 00-1.555-.832L4.12 8.128a1 1 0 000 1.664l4.325 3.04zM11 5.792v8.416a1 1 0 001.555.832l4.325-3.04a1 1 0 000-1.664l-4.325-3.04A1 1 0 0011 5.792z"/></svg></button>
                                <button id="play-pause-btn" class="p-3 bg-blue-500 rounded-full hover:bg-blue-600 transition-colors"><svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.002v3.996a1 1 0 001.555.832l3.198-2a1 1 0 000-1.664l-3.198-2z" clip-rule="evenodd" /></svg></button>
                                <button id="next-btn" class="text-gray-300 hover:text-white"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 5.168A1 1 0 0010 5.792v8.416a1 1 0 001.555.832l4.325-3.04a1 1 0 000-1.664l-4.325-3.04zM9 5.792V14.208a1 1 0 01-1.555.832L3.12 11.972a1 1 0 010-1.664l4.325-3.04A1 1 0 019 5.792z"/></svg></button>
                            </div>
                         </div>
                     </div>
                </div>
                 <div id="comms-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Phone</h2>
                     <div id="contact-list" class="contact-list"></div>
                </div>
                <div id="weather-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Weather</h2>
                     <!-- Weather content will go here -->
                </div>
                <div id="maintenance-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Maintenance</h2>
                     <div id="maintenance-list"></div>
                </div>
                 <div id="youtube-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">YouTube</h2>
                     <form id="youtube-form" class="flex gap-2 mb-2">
                        <input type="text" id="youtube-url" placeholder="Paste YouTube URL" class="flex-grow p-2 rounded border bg-transparent border-gray-500">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Load</button>
                     </form>
                     <div id="youtube-player-container" class="flex-grow"></div>
                </div>
                 <div id="spotify-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Spotify</h2>
                     <form id="spotify-form" class="flex gap-2 mb-2">
                        <input type="text" id="spotify-uri" placeholder="Paste Spotify URL or URI" class="flex-grow p-2 rounded border bg-transparent border-gray-500">
                        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Load</button>
                     </form>
                     <div id="spotify-player-container" class="flex-grow"></div>
                </div>
                <div id="search-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Search</h2>
                     <div id="chat-container" class="chat-container"></div>
                     <form id="chat-form" class="chat-input-form">
                         <input type="text" id="chat-input" placeholder="Ask anything..." class="flex-grow p-2 rounded-l border bg-transparent border-gray-500">
                         <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r">Send</button>
                     </form>
                </div>
                <div id="settings-screen" class="screen flex flex-col p-4">
                     <h2 class="app-header">Settings</h2>
                     <div class="settings-item">
                         <span class="font-bold text-lg">Theme</span>
                         <div class="theme-options" id="theme-options">
                             <button data-theme="light">Light</button>
                             <button data-theme="dark">Dark</button>
                             <button data-theme="auto">Auto</button>
                         </div>
                     </div>
                     <div class="settings-item">
                         <span class="font-bold text-lg">Units</span>
                         <div class="theme-options" id="unit-options">
                             <button data-unit="metric">km/h</button>
                             <button data-unit="imperial">mph</button>
                         </div>
                     </div>
                </div>
            </div>

            <div class="dock">
                <!-- Dock items will be rendered by JS -->
            </div>
        </div>
        
        <div id="confirm-modal" class="absolute inset-0 bg-black/70 z-[9998] flex items-center justify-center">
            <div class="w-full max-w-sm bg-[var(--theme-surface)] rounded-lg p-6 text-center">
                <h3 class="text-xl font-bold mb-2">Turn Off Screen?</h3>
                <p class="text-[var(--theme-text-secondary)] mb-6">The time and speed will remain visible.</p>
                <div class="flex gap-4">
                    <button id="confirm-cancel" class="flex-1 p-3 rounded-lg border border-[var(--theme-border)]">Cancel</button>
                    <button id="confirm-continue" class="flex-1 p-3 rounded-lg bg-[var(--theme-accent)] text-white">Continue</button>
                </div>
            </div>
        </div>

        <div id="sleep-screen" class="flex-col items-center justify-center">
            <div id="sleep-time" class="text-8xl font-bold text-white sleep-content"></div>
            <div id="sleep-speed" class="absolute bottom-4 text-2xl text-white sleep-content"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const infotainmentContainer = document.getElementById('infotainment-container');
            const startupScreen = document.getElementById('startup-screen');
            const loginScreen = document.getElementById('login-screen');
            const mainContentWrapper = document.querySelector('.main-content-wrapper');
            const contentArea = document.querySelector('.content-area');
            const dockContainer = document.querySelector('.dock');
            const screens = document.querySelectorAll('.screen');
            const themeOptions = document.getElementById('theme-options');
            const unitOptions = document.getElementById('unit-options');
            const signInForm = document.getElementById('signin-form');
            const guestButton = document.getElementById('guest-button');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmCancelBtn = document.getElementById('confirm-cancel');
            const confirmContinueBtn = document.getElementById('confirm-continue');
            const sleepScreen = document.getElementById('sleep-screen');
            const sleepTime = document.getElementById('sleep-time');
            const sleepSpeed = document.getElementById('sleep-speed');
            const tbtContainer = document.getElementById('turn-by-turn-container');
            
            // --- Sound Engine ---
            const navSynth = new Tone.Synth().toDestination();

            // --- State & Data ---
            let homeMap, navMap, routingControl, poiMap;
            let poiMarkers = L.layerGroup();
            let destinationMarker = null;
            let settings = { theme: 'auto', units: 'metric' };
            let currentUserLocation = null;
            let currentSpeedMps = 0;
            let currentRoute = null;
            let currentInstructionIndex = 0;

            const appData = [
                { id: 'home-screen', name: 'Home', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>` },
                { id: 'nav-screen', name: 'Nav', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>` },
                { id: 'music-screen', name: 'Media', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>` },
                { id: 'comms-screen', name: 'Phone', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24c1.12.37 2.33.57 3.57.57c.55 0 1 .45 1 1V20c0 .55-.45 1-1 1c-9.39 0-17-7.61-17-17c0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1c0 1.25.2 2.45.57 3.57c.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>` },
                { id: 'apps-screen', name: 'Apps', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>` },
                { id: 'settings-screen', name: 'Settings', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5s3.5 1.57 3.5 3.5s-1.57 3.5-3.5 3.5z"/></svg>` }
            ];
             const secondaryApps = [
                 { id: 'poi-screen', name: 'POI', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 3.16 1.87 5.88 4.45 7.15.1.05.2.07.3.1.25.08.51.08.76 0 .1-.03.2-.05.3-.1C17.13 14.88 19 12.16 19 9c0-3.87-3.13-7-7-7zm0 2c2.76 0 5 2.24 5 5 0 2.43-1.46 4.45-3.51 5.43-.16.07-.32.1-.49.1s-.33-.03-.49-.1C9.46 13.45 8 11.43 8 9c0-2.76 2.24-5 5-5zm-1.5 6H9v-2h1.5v2zm3 0h-1.5v-2H15v2zm1.5-3.5h-1.5v-2H18L16.5 8.5zM6 8.5L7.5 7H6v1.5z"/></svg>`},
                 { id: 'weather-screen', name: 'Weather', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/></svg>`},
                 { id: 'maintenance-screen', name: 'Maintenance', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12.68 2.06c-1.27-.47-2.67-.2-3.69.83l-6.6 6.6c-1.23 1.23-1.36 3.14-.38 4.51l-1.33 1.33c-.78.78-.78 2.05 0 2.83l2.47 2.47c.78.78 2.05.78 2.83 0l1.33-1.33c1.37.98 3.28.85 4.51-.38l6.6-6.6c1.03-1.03 1.3-2.42.83-3.69l-3.1-1.16-2.02 2.02c-.2-.17-.43-.3-.68-.39l-1.43-3.8-3.8-1.43c-.09-.25-.22-.48-.39-.68l2.02-2.02-1.16-3.1z"/></svg>` },
                 { id: 'youtube-screen', name: 'YouTube', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>` },
                 { id: 'spotify-screen', name: 'Spotify', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.14 14.28c-.24.36-.72.48-1.08.24-2.94-1.8-6.54-2.22-10.92-.96-.42.12-.84-.18-.96-.6-.12-.42.18-.84.6-.96C9.24 12.84 13.2 13.32 16.5 15.36c.36.24.48.72.24 1.08zm1.02-2.28c-.3.42-.84.54-1.26.24-3.24-1.98-8.1-2.52-11.7-1.38-.54.18-.96-.18-1.14-.72s.18-.96.72-1.14c4.08-1.26 9.36-.66 12.96 1.56.42.3.54.84.24 1.26zm.12-2.34c-3.6-2.22-9.6-2.4-13.02-1.32-.6.18-1.2-.24-1.38-.84s.24-1.2.84-1.38C11.22 6.3 17.76 6.54 21.9 9c.54.3.72.96.42 1.5s-.96.72-1.5.42z"/></svg>`},
                 { id: 'search-screen', name: 'Search', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>` },
                 { id: 'screen-off', name: 'Screen Off', icon: `<svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg>` },
            ];
            
            let maintenanceData = [
                { id: 'lube-chain', name: 'Lube Chain', interval: 300, lastReset: 0 },
                { id: 'check-brakes', name: 'Check Brakes', interval: 500, lastReset: 0 },
                { id: 'tire-sealant', name: 'Tire Sealant', interval: 1000, lastReset: 0 },
            ];

            const contacts = [
                { name: 'Jane Doe', phone: '555-123-4567' },
                { name: 'John Smith', phone: '555-987-6543' },
            ];

            // --- Initialization ---
            function startApp() {
                loadSettings();
                updateTheme();
                startupScreen.classList.add('hidden');
                loginScreen.classList.add('active');
            }
            setTimeout(startApp, 2500);

            function initializeMainApp() {
                loginScreen.classList.remove('active');
                mainContentWrapper.style.display = 'flex';

                updateUnitButtonsUI();
                renderDock();
                renderAppsGrid();
                renderContacts();
                updateMaintenanceLog();
                showScreen('home-screen');
                initMaps();
                setInterval(updateTime, 1000);
                setInterval(checkThemeSchedule, 60000); // Check every minute
            }
            
            signInForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email-input').value;
                initializeMainApp();
                setTimeout(() => showNotification(`Logged in as ${email}. Full features enabled.`), 500);
            });

            guestButton.addEventListener('click', () => {
                initializeMainApp();
                setTimeout(() => showNotification('Continuing as Guest. Some features may be limited.'), 500);
            });

            
            // --- Theme & Settings ---
            function saveSettings() {
                localStorage.setItem('sync3Settings', JSON.stringify(settings));
            }

            function loadSettings() {
                const saved = localStorage.getItem('sync3Settings');
                if (saved) {
                    settings = { ...{ theme: 'auto', units: 'metric' }, ...JSON.parse(saved) };
                }
            }

            function applyTheme(theme) {
                infotainmentContainer.classList.remove('theme-light', 'theme-dark');
                infotainmentContainer.classList.add(`theme-${theme}`);
                themeOptions.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === settings.theme);
                });
            }

            function checkThemeSchedule() {
                if (settings.theme !== 'auto') return;
                const now = new Date();
                const minutes = now.getHours() * 60 + now.getMinutes();
                const lightStart = 9 * 60;
                const darkStart = 18 * 60 + 30;
                applyTheme((minutes >= lightStart && minutes < darkStart) ? 'light' : 'dark');
            }
            
            function updateTheme() {
                if (settings.theme === 'auto') {
                    checkThemeSchedule();
                } else {
                    applyTheme(settings.theme);
                }
            }

            function updateUnitButtonsUI() {
                unitOptions.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.unit === settings.units);
                });
            }
            
            themeOptions.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    settings.theme = e.target.dataset.theme;
                    saveSettings();
                    updateTheme();
                }
            });

            unitOptions.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    settings.units = e.target.dataset.unit;
                    saveSettings();
                    updateUnitButtonsUI();
                    updateSpeedometer(currentSpeedMps);
                }
            });
            
            function updateTime() {
                 const now = new Date();
                 const hours = now.getHours().toString().padStart(2, '0');
                 const minutes = now.getMinutes().toString().padStart(2, '0');
                 if(sleepTime) sleepTime.textContent = `${hours}:${minutes}`;
            }

            // --- UI Logic & Rendering ---
            const screenMap = new Map();
            screens.forEach(screen => screenMap.set(screen.id, screen));
            
            function showScreen(screenId) {
                screens.forEach(s => s.classList.remove('active'));
                const newScreen = screenMap.get(screenId);
                if(newScreen) newScreen.classList.add('active');
                document.querySelectorAll('.dock-item').forEach(item => item.classList.toggle('active', item.dataset.screen === screenId));
                if (screenId === 'nav-screen' && navMap) setTimeout(() => navMap.invalidateSize(), 10);
                if (screenId === 'home-screen' && homeMap) setTimeout(() => homeMap.invalidateSize(), 10);
                if (screenId === 'poi-screen' && poiMap) setTimeout(() => poiMap.invalidateSize(), 10);
            }

            function showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                infotainmentContainer.appendChild(notification);

                setTimeout(() => notification.classList.add('show'), 10);

                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 500);
                }, 4000);
            }

            function renderDock() {
                dockContainer.innerHTML = '';
                appData.forEach(app => {
                    const dockItem = document.createElement('button');
                    dockItem.className = 'dock-item';
                    dockItem.dataset.screen = app.id;
                    dockItem.innerHTML = `${app.icon}<span>${app.name}</span>`;
                    dockContainer.appendChild(dockItem);
                });
                document.querySelectorAll('.dock-item').forEach(item => item.addEventListener('click', () => {
                    navSynth.triggerAttackRelease("E5", 0.1);
                    showScreen(item.dataset.screen);
                }));
            }

            function renderAppsGrid() {
                 const appsGrid = document.getElementById('apps-grid');
                 appsGrid.innerHTML = '';
                 secondaryApps.forEach(app => {
                    const appItem = document.createElement('div');
                    appItem.className = 'app-item';
                    appItem.dataset.screen = app.id;
                    appItem.innerHTML = `<div class="icon-bg">${app.icon}</div><span>${app.name}</span>`;
                    appItem.addEventListener('click', () => {
                         if (app.id === 'screen-off') {
                            confirmModal.style.display = 'flex';
                        } else {
                            showScreen(app.id);
                        }
                    });
                    appsGrid.appendChild(appItem);
                });
            }
            
            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
            });

            confirmContinueBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                mainContentWrapper.classList.add('fade-out');
                setTimeout(() => {
                    mainContentWrapper.style.display = 'none';
                    sleepScreen.classList.add('active');
                    updateTime();
                    updateSpeedometer(currentSpeedMps);
                }, 400);
            });

            sleepScreen.addEventListener('click', () => {
                sleepScreen.classList.remove('active');
                mainContentWrapper.style.display = 'flex';
                mainContentWrapper.classList.remove('fade-out');
                showScreen('home-screen');
            });

            function renderContacts() {
                const contactList = document.getElementById('contact-list');
                if(!contactList) return;
                contactList.innerHTML = '';
                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-item';
                    item.innerHTML = `
                        <div>
                            <p class="name">${contact.name}</p>
                            <p class="text-sm text-gray-400">${contact.phone}</p>
                        </div>
                        <div class="actions">
                            <a href="tel:${contact.phone}"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path></svg></a>
                            <a href="sms:${contact.phone}"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd"></path></svg></a>
                        </div>
                    `;
                    contactList.appendChild(item);
                });
            }

            function updateMaintenanceLog(distanceKm = 0) {
                const list = document.getElementById('maintenance-list');
                if(!list) return;
                list.innerHTML = '';
                maintenanceData.forEach(item => {
                    const distSinceReset = distanceKm - item.lastReset;
                    const progress = Math.min(100, (distSinceReset / item.interval) * 100);
                    let color = 'bg-green-500';
                    if (progress > 70) color = 'bg-yellow-500';
                    if (progress > 90) color = 'bg-red-500';

                    const itemEl = document.createElement('div');
                    itemEl.className = 'maintenance-item';
                    itemEl.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">${item.name}</span>
                            <span>${distSinceReset.toFixed(0)} / ${item.interval} km</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar ${color}" style="width: ${progress}%"></div>
                        </div>
                    `;
                    list.appendChild(itemEl);
                });
            }
            
            // --- Map & Navigation ---
            function getTurnIcon(type) {
                const icons = {
                    'Straight': `<svg viewBox="0 0 24 24"><path d="M12 2L12 22M12 2L6 8M12 2L18 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                    'Left': `<svg viewBox="0 0 24 24"><path d="M12 22V8H4M12 22L6 16M12 22L18 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                    'Right': `<svg viewBox="0 0 24 24"><path d="M12 22V8H20M12 22L18 16M12 22L6 16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                    'SlightRight': `<svg viewBox="0 0 24 24"><path d="M5 19L19 5M19 5V12M19 5H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                    'SlightLeft': `<svg viewBox="0 0 24 24"><path d="M19 19L5 5M5 5V12M5 5H12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
                };
                return icons[type] || icons['Straight'];
            }

            function updateTurnByTurnUI(userLocation) {
                if (!currentRoute) return;
                
                const routeCoords = currentRoute.coordinates;
                
                let closestPointIndex = 0;
                let minDistance = Infinity;

                for (let i = 0; i < routeCoords.length; i++) {
                    const distance = L.latLng(routeCoords[i].lat, routeCoords[i].lng).distanceTo(userLocation);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestPointIndex = i;
                    }
                }

                let nextInstructionIndex = -1;
                for (let i = 0; i < currentRoute.instructions.length; i++) {
                    if (currentRoute.instructions[i].index >= closestPointIndex) {
                        nextInstructionIndex = i;
                        break;
                    }
                }

                if (nextInstructionIndex !== -1 && nextInstructionIndex < currentRoute.instructions.length) {
                    const instruction = currentRoute.instructions[nextInstructionIndex];
                    document.getElementById('tbt-icon').innerHTML = getTurnIcon(instruction.type);
                    document.getElementById('tbt-road').textContent = instruction.road || 'Continue';
                    
                    const distToNext = userLocation.distanceTo(L.latLng(routeCoords[instruction.index].lat, routeCoords[instruction.index].lng));
                    const displayDist = settings.units === 'imperial' ? `${(distToNext * 0.000621371).toFixed(2)} mi` : `${(distToNext / 1000).toFixed(2)} km`;
                    document.getElementById('tbt-distance').textContent = displayDist;
                }
            }


            function initMaps() {
                homeMap = L.map('home-map-container', { zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false }).setView([50.1109, 8.6821], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(homeMap);

                navMap = L.map('map', { zoomControl: false, attributionControl: false }).setView([50.1109, 8.6821], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(navMap);
                
                poiMap = L.map('poi-map', { zoomControl: false, attributionControl: false }).setView([50.1109, 8.6821], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(poiMap);
                poiMarkers.addTo(poiMap);

                 if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(position => {
                        const { latitude, longitude, speed } = position.coords;
                        currentUserLocation = L.latLng(latitude, longitude);
                        currentSpeedMps = speed || 0;
                        
                        if(homeMap) homeMap.setView(currentUserLocation, 15);
                        if(poiMap) poiMap.setView(currentUserLocation, 15);
                        if (navMap && document.getElementById('nav-screen').classList.contains('active')) {
                           navMap.panTo(currentUserLocation);
                        }
                        updateSpeedometer(currentSpeedMps);
                        updateTurnByTurnUI(currentUserLocation);
                    }, () => {}, { enableHighAccuracy: true });
                }

                document.getElementById('nav-search-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('nav-search-input');
                    const query = input.value;
                    if (!query) return;

                    input.disabled = true;
                    input.placeholder = "Searching...";

                    if (routingControl) navMap.removeControl(routingControl);
                    if (destinationMarker) navMap.removeLayer(destinationMarker);
                    tbtContainer.classList.remove('visible');

                    const geocoder = L.Control.Geocoder.nominatim();
                    geocoder.geocode(query, (results) => {
                        input.disabled = false;
                        input.placeholder = "Where to?";
                        
                        if (results && results.length > 0) {
                            startRouting(results[0].center);
                        } else {
                            showNotification(`No results found for "${query}"`);
                        }
                    });
                });

                document.getElementById('poi-controls').addEventListener('click', e => {
                    if(e.target.tagName === 'BUTTON'){
                        const poiType = e.target.dataset.poi;
                        searchForPOI(poiType);
                    }
                });

                poiMap.on('popupopen', e => {
                    const lat = e.popup.getElement().dataset.lat;
                    const lng = e.popup.getElement().dataset.lng;
                    document.getElementById('poi-route-btn').addEventListener('click', () => {
                        showScreen('nav-screen');
                        startRouting(L.latLng(lat, lng));
                    });
                });
            }

            async function searchForPOI(poiType){
                if(!currentUserLocation) {
                    showNotification("Current location not available.");
                    return;
                }
                poiMarkers.clearLayers();
                showNotification(`Searching for ${poiType.replace('_', ' ')}...`);
                
                const { lat, lng } = currentUserLocation;
                const searchRadius = 0.05; // Approx 5km
                const bbox = `${lng - searchRadius},${lat - searchRadius},${lng + searchRadius},${lat + searchRadius}`;
                
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${poiType}&format=json&viewbox=${bbox}&bounded=1&limit=10`);
                const data = await response.json();

                if (data && data.length > 0) {
                    data.forEach(place => {
                        const marker = L.marker([place.lat, place.lon]).addTo(poiMarkers);
                        const popupContent = `
                            <div class="p-1 text-center">
                                <strong class="text-base">${place.display_name.split(',')[0]}</strong>
                                <button id="poi-route-btn" class="w-full bg-[var(--theme-accent)] text-white p-2 rounded mt-2 text-sm">Start Route</button>
                            </div>
                        `;
                        const popup = L.popup().setContent(popupContent);
                        popup.getElement().dataset.lat = place.lat;
                        popup.getElement().dataset.lng = place.lon;
                        marker.bindPopup(popup);
                    });
                     poiMap.fitBounds(poiMarkers.getBounds(), {padding: [50, 50]});
                } else {
                    showNotification(`No nearby ${poiType.replace('_', ' ')} found.`);
                }
            }

            function startRouting(destination) {
                if (routingControl) navMap.removeControl(routingControl);
                if (destinationMarker) navMap.removeLayer(destinationMarker);
                
                if (!currentUserLocation) {
                    showNotification('Could not get current location to start route.');
                    return;
                }

                routingControl = L.Routing.control({
                    waypoints: [currentUserLocation, destination],
                    routeWhileDragging: false,
                    show: false,
                    lineOptions: { styles: [{color: 'var(--theme-accent)', opacity: 0.8, weight: 6}] },
                    createMarker: () => null
                })
                .on('routesfound', (e) => {
                    currentRoute = e.routes[0];
                })
                .addTo(navMap);
                navMap.fitBounds(L.latLngBounds(currentUserLocation, destination), {padding: [50, 50]});
            }

            function updateSpeedometer(speedMps) {
                const speedDisplay = document.getElementById('home-speed-display');
                const speedUnit = document.getElementById('home-speed-unit');
                const displaySpeed = settings.units === 'imperial' ? (speedMps * 2.23694).toFixed(0) : (speedMps * 3.6).toFixed(0);
                
                if (speedDisplay) speedDisplay.textContent = displaySpeed;
                if (speedUnit) speedUnit.textContent = settings.units === 'imperial' ? 'mph' : 'km/h';
                if (sleepSpeed) sleepSpeed.textContent = `${displaySpeed} ${settings.units === 'imperial' ? 'mph' : 'km/h'}`;
            }
            
            // --- App Specific Logic ---
            document.getElementById('youtube-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const url = document.getElementById('youtube-url').value;
                const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                if (videoId) {
                    document.getElementById('youtube-player-container').innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            });

            document.getElementById('spotify-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const uriInput = document.getElementById('spotify-uri').value;
                let embedUrl = '';
                try {
                    if (uriInput.startsWith('https://open.spotify.com/')) {
                        const url = new URL(uriInput);
                        const pathParts = url.pathname.split('/');
                        const type = pathParts[1];
                        const id = pathParts[2];
                        if (type && id) {
                             embedUrl = `https://open.spotify.com/embed/${type}/${id}`;
                        }
                    } else if (uriInput.startsWith('spotify:')) {
                        const parts = uriInput.split(':');
                        const type = parts[1];
                        const id = parts[2];
                         if (type && id) {
                             embedUrl = `https://open.spotify.com/embed/${type}/${id}`;
                        }
                    }
                } catch (error) {
                    console.error("Invalid Spotify URL or URI", error);
                    showNotification("Invalid Spotify URL or URI");
                    return;
                }

                if (embedUrl) {
                    document.getElementById('spotify-player-container').innerHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
                } else {
                    showNotification("Could not parse Spotify link.");
                }
            });
        });
    </script>
</body>
</html>

